<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>لوحة إدارة البورتفوليو</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap">
<style>
:root{--bg:#0f172a;--card:#1e293b;--text:#e2e8f0;--accent:#06b6d4;--muted:#94a3b8}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',sans-serif}
.wrap{max-width:900px;margin:auto;padding:20px}
.card{background:var(--card);padding:16px;border-radius:16px;margin-bottom:16px;border:1px solid #334155}
h1,h2,h3{color:var(--accent);margin:0 0 10px}
label{display:block;margin:8px 0 4px}
input,select,textarea{width:100%;padding:10px;background:#0b1320;color:var(--text);border:1px solid #334155;border-radius:10px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.btn{display:inline-block;background:var(--accent);color:#fff;padding:10px 14px;border:none;border-radius:10px;font-weight:700;cursor:pointer;margin-top:10px}
.btn.secondary{background:#334155}
.btn.danger{background:#dc2626}
small{color:var(--muted)}
.list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.item{border:1px solid #334155;border-radius:12px;overflow:hidden}
.item img{width:100%;height:140px;object-fit:cover;display:block}
.item .meta{padding:10px;font-size:13px;color:var(--muted)}
.item .actions{display:flex;gap:6px;padding:10px}
.pin{display:flex;gap:8px;align-items:center}
hr{border:0;border-top:1px solid #334155;margin:16px 0}
.badge{display:inline-block;background:#0b1320;border:1px solid #334155;border-radius:8px;padding:4px 8px;margin-inline-start:8px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>لوحة إدارة البورتفوليو</h1>

  <div class="card">
    <h3>أمان بسيط (ليس بديلاً عن تسجيل الدخول)</h3>
    <div class="pin">
      <input id="pin" type="password" placeholder="أدخل PIN بسيط (مثلاً 2025)" />
      <button class="btn" onclick="login()">دخول</button>
      <small>ملاحظة: هذا حماية شكلية محلية فقط.</small>
    </div>
  </div>

  <div id="app" style="display:none">
    <div class="card">
      <h2>إضافة عنصر <span id="quota" class="badge">الحجم: —</span></h2>
      <div class="row">
        <div>
          <label>القسم</label>
          <select id="section">
            <option value="designs">أعمال التصميم الإعلاني</option>
            <option value="campaigns">أداء الحملات الإعلانية</option>
            <option value="certs">الدورات والشهادات</option>
          </select>
        </div>
        <div>
          <label>روابط صور (اختياري — سطر لكل رابط)</label>
          <textarea id="imgUrl" rows="4" placeholder="https://example.com/1.jpg
https://example.com/2.jpg"></textarea>
        </div>
      </div>

      <div class="row">
        <div>
          <label>رفع صور من جهازك (يدعم تحديد عدة صور)</label>
          <input id="imgFile" type="file" accept="image/*" multiple />
          <small>نضغط الصور تلقائيًا (WebP، أقصى عرض 1280px) لتقليل الحجم.</small>
        </div>
        <div>
          <label>رابط خارجي (اختياري — للشهادات مثلاً)</label>
          <input id="linkUrl" type="url" placeholder="https://..." />
        </div>
      </div>

      <div class="row">
        <div>
          <label>وصف قصير (اختياري)</label>
          <input id="caption" type="text" placeholder="وصف مختصر" />
        </div>
        <div>
          <label>معاينة أول ملف</label>
          <img id="preview" style="width:100%;height:140px;object-fit:cover;border-radius:10px;border:1px solid #334155" alt="">
        </div>
      </div>

      <button class="btn" onclick="addItem()">إضافة</button>
      <small id="msg"></small>
    </div>

    <div class="card">
      <h2>إضافة قسم جديد</h2>
      <div class="row">
        <div>
          <label>اسم القسم (مثال: أعمال الفيديو، أعمال الطباعة…)</label>
          <input id="newSectionName" type="text" placeholder="اسم القسم" />
        </div>
        <div style="display:flex;align-items:end;gap:10px">
          <button class="btn" onclick="addSection()">إضافة القسم</button>
        </div>
      </div>
      <small>سيظهر القسم فورًا في القوائم، ويمكنك الإضافة له مباشرة.</small>
    </div>

    <div class="card">
      <h2>القائمة الحالية</h2>
      <div>
        <label>اختر القسم لعرض القائمة</label>
        <select id="viewSection" onchange="renderList()">
          <option value="designs">أعمال التصميم الإعلاني</option>
          <option value="campaigns">أداء الحملات الإعلانية</option>
          <option value="certs">الدورات والشهادات</option>
        </select>
      </div>
      <div class="list" id="list"></div>
    </div>

    <div class="card">
      <h2>نسخ احتياطي</h2>
      <div class="row">
        <div>
          <label>تصدير البيانات</label>
          <button class="btn secondary" onclick="exportData()">تنزيل JSON</button>
        </div>
        <div>
          <label>استيراد البيانات</label>
          <input id="importFile" type="file" accept="application/json" />
          <button class="btn" onclick="importData()">استيراد</button>
        </div>
      </div>
      <hr>
      <button class="btn danger" onclick="resetData()">حذف كل البيانات من المتصفح</button>
      <small>لا يحذف الصور من الإنترنت—يمسح التخزين المحلي فقط.</small>
    </div>
  </div>
</div>

<script>
/* ======== تخزين / بنية عامة ======== */
const KEY = 'als_portfolio_v1';
const PIN_KEY = 'als_pin_ok';

function login(){
  const pin = document.getElementById('pin').value.trim();
  if(!pin){ alert('أدخل PIN'); return; }
  localStorage.setItem(PIN_KEY, '1');
  document.getElementById('app').style.display='block';
  updateQuota();
}

window.addEventListener('load', ()=>{
  if(localStorage.getItem(PIN_KEY)==='1'){
    document.getElementById('app').style.display='block';
  }
  ensureData();
  syncSectionOptions(getData());
  renderList();
  updateQuota();
});

// معاينة أول ملف مختار
document.getElementById('imgFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const dataUrl = await fileToDataURL(f, 1280, 0.82).catch(()=>null);
  if(dataUrl) document.getElementById('preview').src = dataUrl;
});

/* بنية حديثة مع ترحيل من (designs/campaigns/certs) */
function ensureData(){
  if(!localStorage.getItem(KEY)){
    const empty = { sections: { designs:[], campaigns:[], certs:[] } };
    localStorage.setItem(KEY, JSON.stringify(empty));
    return;
  }
  try{
    const raw = JSON.parse(localStorage.getItem(KEY));
    if(!raw.sections){
      const migrated = { sections: {
        designs: raw.designs || [],
        campaigns: raw.campaigns || [],
        certs: raw.certs || []
      }};
      localStorage.setItem(KEY, JSON.stringify(migrated));
    }
  }catch(e){
    const empty = { sections: { designs:[], campaigns:[], certs:[] } };
    localStorage.setItem(KEY, JSON.stringify(empty));
  }
}
function getData(){
  ensureData();
  try { return JSON.parse(localStorage.getItem(KEY)); }
  catch(e){ return { sections: { designs:[], campaigns:[], certs:[] } }; }
}
function setData(data){
  localStorage.setItem(KEY, JSON.stringify(data));
  updateQuota();
}

/* الحصّة التقريبية */
function approxBytesUsed(){
  try{
    const s = localStorage.getItem(KEY) || '';
    return new Blob([s]).size;
  }catch(e){ return 0; }
}
function formatBytes(b){
  if(b < 1024) return b+' B';
  if(b < 1024*1024) return (b/1024).toFixed(1)+' KB';
  return (b/1024/1024).toFixed(2)+' MB';
}
function updateQuota(){
  const el = document.getElementById('quota');
  if(!el) return;
  const used = approxBytesUsed();
  el.textContent = 'الحجم: ' + formatBytes(used) + ' (حد متصفّح ~5–10MB تقريبًا)';
  if(used > 4.5*1024*1024){
    el.style.background='#7c2d12';
    el.title='قارب الامتلاء—فكّر بحذف صور كبيرة أو استخدام استضافة خارجية لاحقًا';
  }
}

/* ======== إضافة عناصر (مجموعة صور + روابط) ======== */
async function addItem(){
  const section = document.getElementById('section').value;
  const linkUrl = document.getElementById('linkUrl').value.trim();
  const caption = document.getElementById('caption').value.trim();
  const files = Array.from(document.getElementById('imgFile').files || []);
  const msg = document.getElementById('msg');

  // روابط متعددة من textarea (سطر لكل رابط)
  const urlText = document.getElementById('imgUrl').value.trim();
  const urlList = urlText ? urlText.split('\n').map(s=>s.trim()).filter(Boolean) : [];

  const data = getData();
  if(!data.sections[section]) data.sections[section] = [];

  let added = 0;

  // 1) روابط مباشرة
  for(const u of urlList){
    data.sections[section].push({
      img: u, ...(linkUrl?{link:linkUrl}:{}) , ...(caption?{caption}:{})
    });
    added++;
  }

  // 2) ملفات مرفوعة (متعددة)
  for(const file of files){
    try{
      let dataUrl = await fileToDataURL(file, 1280, 0.82);
      if(sizeOfDataURL(dataUrl) > 700*1024){
        dataUrl = await fileToDataURL(file, 1080, 0.78);
      }
      data.sections[section].push({
        img: dataUrl, ...(linkUrl?{link:linkUrl}:{}) , ...(caption?{caption}:{})
      });
      added++;
    }catch(e){
      console.warn('فشل تحويل ملف:', file?.name || '');
    }
  }

  setData(data);

  // تنظيف
  document.getElementById('imgUrl').value='';
  document.getElementById('linkUrl').value='';
  document.getElementById('caption').value='';
  document.getElementById('imgFile').value='';
  document.getElementById('preview').src='';
  msg.textContent = added ? ('تمت إضافة ' + added + ' عنصرًا.') : 'لم تتم إضافة عناصر.';

  renderList();
}

/* ======== الأقسام ======== */
function addSection(){
  const name = document.getElementById('newSectionName').value.trim();
  if(!name) return alert('اكتب اسم القسم.');
  const data = getData();
  const key = name.trim().toLowerCase().replace(/\s+/g,'_');
  if(data.sections[key]) return alert('هذا القسم موجود.');

  data.sections[key] = [];
  setData(data);
  addOptionIfMissing(document.getElementById('section'), key, name);
  addOptionIfMissing(document.getElementById('viewSection'), key, name);
  document.getElementById('newSectionName').value = '';
  alert('تمت إضافة القسم.');
  renderList();
}
function addOptionIfMissing(selectEl, value, label){
  const exists = Array.from(selectEl.options).some(o=>o.value===value);
  if(!exists){
    const opt = document.createElement('option');
    opt.value = value; opt.textContent = label;
    selectEl.appendChild(opt);
  }
}
function syncSectionOptions(data){
  const namesMap = {
    designs: 'أعمال التصميم الإعلاني',
    campaigns: 'أداء الحملات الإعلانية',
    certs: 'الدورات والشهادات'
  };
  const sectionSelect = document.getElementById('section');
  const viewSelect = document.getElementById('viewSection');

  Object.keys(data.sections).forEach(k=>{
    const label = namesMap[k] || k.replace(/_/g,' ');
    addOptionIfMissing(sectionSelect, k, label);
    addOptionIfMissing(viewSelect, k, label);
  });
}

/* ======== عرض القائمة / إدارة العناصر ======== */
function renderList(){
  const section = document.getElementById('viewSection').value;
  const data = getData();
  const list = document.getElementById('list');
  list.innerHTML='';

  const arr = (data.sections && data.sections[section]) ? data.sections[section] : [];
  arr.forEach((it,idx)=>{
    const card = document.createElement('div');
    card.className='item';
    card.innerHTML = `
      ${it.link ? `<a href="${it.link}" target="_blank">` : ``}
      <img src="${it.img}" alt="">
      ${it.link ? `</a>` : ``}
      <div class="meta">${it.caption ?? ''}</div>
      <div class="actions">
        <button class="btn secondary" onclick="moveItem('${section}', ${idx}, -1)">↑</button>
        <button class="btn secondary" onclick="moveItem('${section}', ${idx}, 1)">↓</button>
        <button class="btn danger" onclick="deleteItem('${section}', ${idx})">حذف</button>
      </div>
    `;
    list.appendChild(card);
  });

  // تأكد أن القوائم تحتوي كل الأقسام
  syncSectionOptions(data);
}
function moveItem(section, idx, dir){
  const data = getData();
  const arr = data.sections[section];
  const newIdx = idx + dir;
  if(newIdx<0 || newIdx>=arr.length) return;
  [arr[idx], arr[newIdx]] = [arr[newIdx], arr[idx]];
  setData(data); renderList();
}
function deleteItem(section, idx){
  const data = getData();
  data.sections[section].splice(idx,1);
  setData(data); renderList();
}

/* ======== نسخ احتياطي ======== */
function exportData(){
  const data = getData();
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'als_portfolio_backup.json';
  a.click();
}
function importData(){
  const f = document.getElementById('importFile').files[0];
  if(!f) return alert('اختر ملف JSON');
  const r = new FileReader();
  r.onload = () => {
    try{
      const loaded = JSON.parse(r.result);
      if(!(loaded.sections && typeof loaded.sections==='object')) throw Error('بنية غير صحيحة');
      setData(loaded); renderList(); updateQuota();
      alert('تم الاستيراد.');
    }catch(e){ alert('ملف غير صالح.'); }
  };
  r.readAsText(f);
}
function resetData(){
  if(confirm('هل أنت متأكد من حذف كل البيانات المحلية؟')){
    localStorage.removeItem(KEY); ensureData(); renderList(); updateQuota();
  }
}

/* ======== أدوات صور ======== */
function sizeOfDataURL(dataUrl){
  const head = 'base64,';
  const i = dataUrl.indexOf(head);
  if(i === -1) return 0;
  const b64 = dataUrl.slice(i + head.length);
  return Math.floor((b64.length * 3) / 4);
}
function loadImage(file){
  return new Promise((resolve,reject)=>{
    const img = new Image();
    img.onload = ()=> resolve(img);
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}
async function fileToDataURL(file, maxW=1280, quality=0.82){
  const img = await loadImage(file);
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  const ratio = img.width / img.height;
  const w = Math.min(maxW, img.width);
  const h = Math.round(w / ratio);

  canvas.width = w; canvas.height = h;
  ctx.drawImage(img, 0, 0, w, h);

  // WebP (مع شفافية) — وإن لم يدعم المتصفح يرجع JPEG تلقائيًا
  const mime = 'image/webp';
  const dataUrl = canvas.toDataURL(mime, quality);
  return dataUrl;
}
</script>
</body>
</html>
