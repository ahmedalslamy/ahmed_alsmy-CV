<script>
(function(){
  const STORE_KEY = 'als_portfolio_v1';

  function readStore(){
    try{
      const raw = localStorage.getItem(STORE_KEY);
      if(!raw) return null;
      const d = JSON.parse(raw);
      if(!('designs' in d && 'campaigns' in d && 'certs' in d)) return null;
      return d;
    }catch(e){ return null; }
  }

  function buildGrid(items, container, makeLinks=false){
    if(!container) return;
    container.innerHTML = '';
    if(!items || !items.length) return;
    items.forEach((it,i)=>{
      const wrap = document.createElement('div');
      wrap.className = 'work-item';
      const img = document.createElement('img');
      img.src = it.img;
      img.alt = it.caption || ('عنصر ' + (i+1));
      if(makeLinks && it.link){
        const a = document.createElement('a');
        a.href = it.link; a.target = '_blank'; a.rel = 'noopener';
        a.appendChild(img);
        wrap.appendChild(a);
      }else{
        wrap.appendChild(img);
      }
      container.appendChild(wrap);
    });
  }

  function initLightbox(){
    const lightbox = document.getElementById('lightbox');
    if(!lightbox) return;
    const lightboxImg = lightbox.querySelector('img');

    // جميع صور .work-item ما عدا اللي داخل <a> (الشهادات القابلة للنقر)
    const imgs = Array.from(document.querySelectorAll('.work-item img'))
      .filter(img => !(img.parentElement && img.parentElement.tagName.toLowerCase() === 'a'));

    let idx = 0;
    imgs.forEach((img,i)=>{
      img.addEventListener('click', ()=>{
        idx = i;
        lightboxImg.src = imgs[idx].src;
        lightbox.classList.add('show');
      });
    });

    const nextBtn = lightbox.querySelector('.next');
    const prevBtn = lightbox.querySelector('.prev');

    if(nextBtn){
      nextBtn.onclick = (e)=>{ e.stopPropagation(); idx = (idx+1) % imgs.length; lightboxImg.src = imgs[idx].src; };
    }
    if(prevBtn){
      prevBtn.onclick = (e)=>{ e.stopPropagation(); idx = (idx-1+imgs.length) % imgs.length; lightboxImg.src = imgs[idx].src; };
    }
    lightbox.onclick = ()=> lightbox.classList.remove('show');
  }

  // ابني من المخزن لو موجود
  const data = readStore();
  if(data){
    buildGrid(data.designs, document.getElementById('design-works'), false);
    buildGrid(data.campaigns, document.getElementById('campaign-works'), false);
    buildGrid(data.certs, document.getElementById('cert-works'), true);
  }
  // (إعادة) تهيئة اللايت بوكس بعد البناء
  initLightbox();
})();
</script>
